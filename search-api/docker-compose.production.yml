version: '3.8'

# ================================
# Production Environment
# Uses external MongoDB and Qdrant services
# Optimized for VPS deployment
# ================================

services:
  # ================================
  # Search API Application
  # ================================
  search-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: search-api:latest
    container_name: search-api-prod
    restart: always
    ports:
      - "4003:4003"
    environment:
      # Application
      NODE_ENV: production
      PORT: 4003
      LOG_LEVEL: ${LOG_LEVEL:-warn}

      # MongoDB (external service - set in .env.production)
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-toolsearch}

      # Qdrant (external service - set in .env.production)
      QDRANT_URL: ${QDRANT_URL:-}
      QDRANT_HOST: ${QDRANT_HOST:-localhost}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      QDRANT_COLLECTION_NAME: ${QDRANT_COLLECTION_NAME:-tools}

      # Security
      ENABLE_RATE_LIMITING: ${ENABLE_RATE_LIMITING:-true}
      ENABLE_SECURITY_HEADERS: ${ENABLE_SECURITY_HEADERS:-true}
      ENABLE_VECTOR_VALIDATION: ${ENABLE_VECTOR_VALIDATION:-true}

      # CORS (production - specific origins)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Cache
      ENABLE_CACHE: ${ENABLE_CACHE:-true}
      CACHE_TTL: ${CACHE_TTL:-3600}

      # LLM API Keys
      TOGETHER_AI_API_KEY: ${TOGETHER_AI_API_KEY}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY}

      # Search Configuration
      SEARCH_USE_MULTIVECTOR: ${SEARCH_USE_MULTIVECTOR:-true}
      MULTIVECTOR_MAX_RESULTS: ${MULTIVECTOR_MAX_RESULTS:-20}
      SEARCH_RRF_K: ${SEARCH_RRF_K:-60}
      SEARCH_SCORE_THRESHOLD: ${SEARCH_SCORE_THRESHOLD:-0.5}
      QUERY_EXECUTOR_SCORE_THRESHOLD: ${QUERY_EXECUTOR_SCORE_THRESHOLD:-0.5}
      QUERY_EXECUTOR_HIGH_THRESHOLD: ${QUERY_EXECUTOR_HIGH_THRESHOLD:-0.7}

      # Logging
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOGGLY_ENABLED: ${LOGGLY_ENABLED:-false}
      LOGGLY_TOKEN: ${LOGGLY_TOKEN:-}
      LOGGLY_SUBDOMAIN: ${LOGGLY_SUBDOMAIN:-}

    env_file:
      - .env.production

    volumes:
      # Mount logs directory for persistence
      - ./logs:/app/logs
      # Optional: Mount custom config if needed
      # - ./config:/app/config:ro

    networks:
      - search-api-prod-network

    # Resource limits (adjust based on VPS capacity)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4003/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ================================
# Networks
# ================================
networks:
  search-api-prod-network:
    driver: bridge
    name: search-api-prod-network
